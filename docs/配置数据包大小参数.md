# 相机数据包大小配置说明

## 概述

现在可以通过ROS启动文件配置GigE Vision相机的数据包大小（帧长度），以优化网络传输性能。

## 修改内容

### 1. 代码修改 (galaxy_camera.cpp)

添加了可配置的 `gev_packet_size` 参数：

- **参数名称**: `gev_packet_size`
- **取值范围**: 576 - 9000 字节
- **默认值**: 1500 字节（标准以太网）
- **推荐值**:
  - 标准以太网: 1500 字节
  - 巨型帧: 8000-9000 字节（需要网络支持 MTU 9000）

### 2. 启动文件修改 (MER2-302.launch)

在启动文件中添加了完整的网络参数配置段：

```xml
<!-- Network parameters -->
<!-- GigE Vision packet size (576-9000 bytes, default 1500 for standard Ethernet) -->
<!-- Use larger values (8000-9000) for jumbo frames if network supports MTU 9000 -->
<param name="gev_packet_size" value="8000"/>

<!-- Inter-packet delay in microseconds (0-50000, default 5000) -->
<!-- Higher values reduce network congestion but slow down transmission -->
<param name="gev_packet_delay_us" value="5000"/>

<!-- Timeout values in milliseconds -->
<param name="gev_resend_timeout_ms" value="500"/>
<param name="gev_packet_timeout_ms" value="1000"/>
<param name="gev_block_timeout_ms" value="60000"/>

<!-- Socket buffer size in KB (default 8192) -->
<param name="gev_socket_buffer_kb" value="8192"/>
```

## 功能特性

### 1. 自动范围检测

代码会自动查询相机支持的数据包大小范围，并确保设置的值在相机支持的范围内：

```cpp
GX_INT_RANGE packet_size_range;
if (GXGetIntRange(dev_handle_, GX_INT_GEV_PACKETSIZE, &packet_size_range) == GX_STATUS_SUCCESS) {
    // 自动调整到相机支持的范围
    if (packet_size < packet_size_range.nMin) {
        packet_size = packet_size_range.nMin;
    } else if (packet_size > packet_size_range.nMax) {
        packet_size = packet_size_range.nMax;
    }
}
```

### 2. 实际值验证

设置后会验证相机实际使用的数据包大小，并在日志中报告：

```
✓ Packet size set to 8000 bytes
Camera adjusted packet size to 8000 bytes (requested 8000)
```

### 3. 安全边界检查

- **最小值**: 576 字节（最小安全UDP数据包大小）
- **最大值**: 9000 字节（巨型帧最大值）

## 使用方法

### 方法1: 修改启动文件

直接编辑 `MER2-302.launch` 文件中的参数值：

```xml
<param name="gev_packet_size" value="8000"/>
```

### 方法2: 命令行覆盖

启动时通过命令行参数覆盖：

```bash
roslaunch galaxy_camera MER2-302.launch gev_packet_size:=8000
```

### 方法3: 使用默认值

如果不设置该参数，代码会使用默认值 1500 字节。

## 性能优化建议

### 标准以太网 (MTU 1500)

```xml
<param name="gev_packet_size" value="1500"/>
<param name="gev_packet_delay_us" value="5000"/>
```

- 适用于标准网络环境
- 兼容性最好
- 当前实测帧率: 3.08 fps

### 巨型帧 (MTU 9000)

```xml
<param name="gev_packet_size" value="8000"/>
<param name="gev_packet_delay_us" value="5000"/>
```

**前提条件**:
1. 网络接口支持巨型帧
2. 交换机支持巨型帧
3. 所有设备的MTU设置为9000

**配置网络MTU**:
```bash
sudo ip link set eth0 down
sudo ip link set eth0 mtu 9000
sudo ip link set eth0 up
```

**理论性能提升**:
- 4096×3000图像 = 12MB/帧
- 1500字节数据包: 8,556 个数据包
- 8000字节数据包: 1,541 个数据包
- 数据包减少: 5.55倍
- 预期帧率提升: 可达 17+ fps（理论值）

## 数据包大小与性能关系

| 数据包大小 | MTU要求 | 数据包数量 | 传输时间(5ms延迟) | 理论帧率 |
|----------|---------|----------|-----------------|---------|
| 1500字节 | 1500    | 8,556个  | 42.78秒         | 3.08 fps |
| 3000字节 | 3000    | 4,278个  | 21.39秒         | 6.15 fps |
| 6000字节 | 6000    | 2,139个  | 10.70秒         | 12.3 fps |
| 8000字节 | 9000    | 1,541个  | 7.71秒          | 17.1 fps |

**注意**: 实际性能还受相机硬件限制、网络带宽、CPU处理能力等因素影响。

## 故障排除

### 问题1: 相机不支持大数据包

**症状**: 日志显示"Camera adjusted packet size to 1500 bytes"

**解决方案**: 相机硬件可能只支持标准数据包大小，保持使用1500字节。

### 问题2: 网络丢包

**症状**: 帧不完整，大量重传

**解决方案**:
1. 降低数据包大小
2. 增加 `gev_packet_delay_us` 值
3. 检查网络MTU设置
4. 确保交换机支持巨型帧

### 问题3: 性能提升不明显

**可能原因**:
1. 相机硬件限制（如MER2-302可能不支持>1500字节数据包）
2. 网络设备不支持巨型帧
3. 内核配置限制

**验证方法**:
```bash
# 查看实际数据包大小
sudo tcpdump -i eth0 'udp and src <camera_ip>' -n

# 查看MTU设置
ip link show eth0 | grep mtu
```

## 日志信息解读

### 成功配置
```
Camera packet size range: 576 - 9000 bytes
✓ Packet size set to 8000 bytes
```

### 自动调整
```
Requested packet size above camera maximum, adjusted to 1500 bytes
✓ Packet size set to 1500 bytes
Camera adjusted packet size to 1500 bytes (requested 8000)
```

### 配置失败
```
Failed to set packet size to 8000 bytes (status=-1)
```

## 相关参数

配合数据包大小，以下参数也会影响传输性能：

1. **gev_packet_delay_us**: 数据包间延迟（微秒）
   - 降低可提高速度，但可能增加丢包
   
2. **gev_block_timeout_ms**: 帧组装超时（毫秒）
   - 需要足够大以容纳整帧传输时间
   
3. **gev_socket_buffer_kb**: Socket缓冲区大小（KB）
   - 更大的缓冲区可减少丢包

## 更新日期

2025-10-07

## 版本

v1.0 - 初始版本，添加可配置的数据包大小参数
