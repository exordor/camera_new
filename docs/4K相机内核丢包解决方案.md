# 4Kç›¸æœºå†…æ ¸ä¸¢åŒ…é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸš¨ é—®é¢˜ç¡®è®¤

ä» tcpdump è¾“å‡ºå‘ç°ï¼š
```
152366 packets captured
323639 packets received by filter
171269 packets dropped by kernel  â† 53% ä¸¢åŒ…ç‡ï¼
```

## æ ¹æœ¬åŸå› 

### ç›¸æœºé…ç½®
- **åˆ†è¾¨ç‡**: 4096x3000 (12.3 MP) - **æ¯”ä¹‹å‰çš„2048x1536å¤§4å€**
- **å¸§å¤§å°**: 12,288,000 bytes (12 MB)
- **å¸§ç‡**: 5 fps
- **å¸¦å®½éœ€æ±‚**: 60 MB/s = 480 Mbps

### ä¸ºä»€ä¹ˆå†…æ ¸ä¸¢åŒ…

1. **æ•°æ®é‡è¿‡å¤§**: 12 MB/å¸§ï¼Œæ¯”æ ‡å‡†é…ç½®å¤§4å€
2. **é»˜è®¤ç¼“å†²åŒºä¸è¶³**: åŸæ¥çš„64 MBå¯¹äºè¿™ä¸ªç›¸æœºä¸å¤Ÿ
3. **å¤„ç†å»¶è¿Ÿ**: å›è°ƒå¤„ç†21-32 msï¼Œå¯¼è‡´ç¼“å†²åŒºç§¯å‹
4. **LiDARå¹²æ‰°**: unexpected_packets=8,245,210 è¯´æ˜ç½‘ç»œä¸Šæœ‰å¤§é‡å…¶ä»–æµé‡

## âœ… å·²åº”ç”¨çš„ä¼˜åŒ–

### 1. æç«¯å†…æ ¸ç¼“å†²åŒºä¼˜åŒ–
```bash
RX buffer max:     256 MB (ä» 64 MB å¢åŠ  4å€)
RX buffer default: 64 MB  (ä» 16 MB å¢åŠ  4å€)
Device backlog:    30,000 packets (ä» 10,000 å¢åŠ  3å€)
```

### 2. Socketç¼“å†²åŒºä¼˜åŒ–
```xml
gev_socket_buffer_kb: 16384 KB (16 MBï¼Œä» 8 MB ç¿»å€)
```

### 3. è¶…æ—¶è°ƒæ•´
```xml
gev_packet_timeout_ms: 200 ms (ä» 100 ms å¢åŠ )
gev_block_timeout_ms:  5000 ms (ä» 500 ms å¢åŠ  10å€)
```

### 4. CPUæ€§èƒ½æ¨¡å¼
- CPU governor: performance (ç¦ç”¨èŠ‚èƒ½)
- ç½‘ç»œIRQå›ºå®šåˆ°ä¸“ç”¨CPUæ ¸å¿ƒ

### 5. ç½‘ç»œä¼˜åŒ–
- ç¦ç”¨æ‰€æœ‰offloading (GRO, LRO, GSO, TSO)
- æœ€å°åŒ–ä¸­æ–­å»¶è¿Ÿ
- å¢åŠ TXé˜Ÿåˆ—

## ğŸ“Š éªŒè¯ä¼˜åŒ–æ•ˆæœ

### å¯åŠ¨ç›¸æœºå¹¶ç›‘æ§

**ç»ˆç«¯1**: å¯åŠ¨ç›¸æœº
```bash
cd /home/eagrumo/catkin_ws_eagrumo/src/catkin_ws_eas
source devel/setup.bash
roslaunch galaxy_camera MER2-302.launch
```

**ç»ˆç«¯2**: å®æ—¶ç›‘æ§å†…æ ¸ä¸¢åŒ…ï¼ˆ**æœ€é‡è¦**ï¼‰
```bash
/home/eagrumo/catkin_ws_eagrumo/src/catkin_ws_eas/scripts/monitor_kernel_drops.sh
```

**é¢„æœŸè¾“å‡º**ï¼ˆä¼˜åŒ–æˆåŠŸï¼‰:
```
Time            | RX Packets | RX Dropped | Drop Rate | RX Errors
----------------|------------|------------|-----------|----------
21:30:15        |      41000 |          0 |   0.00%   |         0  â† ç»¿è‰²ï¼Œæ— ä¸¢åŒ…
21:30:16        |      41200 |          0 |   0.00%   |         0  â† ç»¿è‰²ï¼Œæ— ä¸¢åŒ…
```

**ç»ˆç«¯3**: tcpdump éªŒè¯
```bash
sudo tcpdump -ni eth0 -c 50000 2>&1 | tail -5
```

**é¢„æœŸè¾“å‡º**ï¼ˆä¼˜åŒ–æˆåŠŸï¼‰:
```
50000 packets captured
50000 packets received by filter
0 packets dropped by kernel  â† åº”è¯¥æ˜¯ 0ï¼
```

**ç»ˆç«¯4**: å¸§ç‡æ£€æŸ¥
```bash
rostopic hz /galaxy_camera/image_raw
```

**é¢„æœŸ**: ~5 Hz ç¨³å®šè¾“å‡º

## ğŸ” å¦‚æœä»ç„¶æœ‰ä¸¢åŒ…

### æ£€æŸ¥ç‚¹ 1: ç¡®è®¤ç¼“å†²åŒºè®¾ç½®
```bash
sysctl net.core.rmem_max
# åº”è¯¥æ˜¯: 268435456 (256 MB)

cat /sys/class/net/eth0/statistics/rx_dropped
# å¯åŠ¨ç›¸æœºåè§‚å¯Ÿæ˜¯å¦å¢é•¿
```

### æ£€æŸ¥ç‚¹ 2: ç¡®è®¤ launch æ–‡ä»¶
```bash
grep gev_socket_buffer_kb ~/.ros/log/latest/galaxy_camera-*-stdout.log
# åº”è¯¥çœ‹åˆ°: Socket buffer size set to 16384KB
```

### æ£€æŸ¥ç‚¹ 3: CPUå ç”¨
```bash
top -p $(pgrep galaxy_camera)
# CPU åº”è¯¥ < 50%
```

### æ£€æŸ¥ç‚¹ 4: ç½‘ç»œå¸¦å®½
```bash
iftop -i eth0
# ç›¸æœºæµé‡åº”è¯¥ ~480 Mbps
# ç¡®è®¤æ²¡æœ‰å…¶ä»–å¤§æµé‡ï¼ˆLiDARåº”è¯¥åœ¨å¦ä¸€ä¸ªæ¥å£ï¼‰
```

## ğŸ’¡ è¿›ä¸€æ­¥ä¼˜åŒ–é€‰é¡¹

å¦‚æœä¼˜åŒ–åä»æœ‰ä¸¢åŒ…ï¼ŒæŒ‰ä¼˜å…ˆçº§è€ƒè™‘ï¼š

### é€‰é¡¹ 1: é™ä½å¸§ç‡ï¼ˆæœ€ç®€å•ï¼‰
```xml
<!-- MER2-302.launch -->
<param name="frame_rate" value="3"/>  <!-- ä» 5 é™åˆ° 3 -->
```
**æ•ˆæœ**: å‡å°‘ 40% æ•°æ®é‡ï¼Œç»™ç¼“å†²åŒºæ›´å¤šæ—¶é—´

### é€‰é¡¹ 2: å‘å¸ƒ Bayer åŸå§‹æ ¼å¼ï¼ˆæœ€æœ‰æ•ˆï¼‰
```xml
<param name="pixel_format" value="bayer_rg8"/>  <!-- ä¸è½¬æ¢RGB -->
```
**æ•ˆæœ**: 
- æ¶ˆé™¤ 21-32 ms çš„è½¬æ¢æ—¶é—´
- å‡å°‘ 67% æ•°æ®é‡ (12 MB â†’ 4 MB)
- å‡ ä¹æ¶ˆé™¤æ‰€æœ‰ä¸¢åŒ…

### é€‰é¡¹ 3: é™ä½åˆ†è¾¨ç‡
```xml
<param name="image_width" value="2048"/>   <!-- ä» 4096 å‡åŠ -->
<param name="image_height" value="1500"/>  <!-- ä» 3000 å‡åŠ -->
```
**æ•ˆæœ**: å‡å°‘ 75% æ•°æ®é‡å’Œå¤„ç†æ—¶é—´

### é€‰é¡¹ 4: ä¸“ç”¨ç½‘ç»œæ¥å£
å¦‚æœLiDARå’Œç›¸æœºå…±äº«åŒä¸€ç½‘å¡ï¼š
```bash
# æ£€æŸ¥ç½‘ç»œæ¥å£
ip link show

# å¦‚æœæœ‰å¤šä¸ªæ¥å£ï¼Œå°†ç›¸æœºç§»åˆ°ä¸“ç”¨æ¥å£
# ä¿®æ”¹ç›¸æœºIPæ®µï¼Œä½¿ç”¨ç‹¬ç«‹ç½‘å¡
```

### é€‰é¡¹ 5: ç¡¬ä»¶å‡çº§
- ä½¿ç”¨10 Gigabitç½‘å¡
- å¢åŠ ç³»ç»Ÿå†…å­˜
- ä½¿ç”¨æ›´å¿«çš„CPU

## ğŸ“ ç›‘æ§æ¸…å•

è¿è¡Œç›¸æœºåï¼Œå®šæœŸæ£€æŸ¥ï¼š

âœ… **å†…æ ¸ä¸¢åŒ…**: `rx_dropped` åº”è¯¥ä¿æŒ 0
```bash
watch -n 1 'cat /sys/class/net/eth0/statistics/rx_dropped'
```

âœ… **å¸§ç‡ç¨³å®š**: åº”è¯¥ç¨³å®šåœ¨ ~5 Hz
```bash
rostopic hz /galaxy_camera/image_raw
```

âœ… **å›è°ƒå¤„ç†æ—¶é—´**: åº”è¯¥ < 30 ms
```
[3] CALLBACK PROCESSING: Avg=XX ms
```

âœ… **SDKä¸¢å¸§**: lost frames åº”è¯¥æœ€å°åŒ–
```
lost=XXX (è¶Šå°è¶Šå¥½)
```

## ğŸ¯ æ€§èƒ½ç›®æ ‡

### ä¼˜åŒ–å‰
- âŒ å†…æ ¸ä¸¢åŒ…: 171,269 packets (53%)
- âŒ å¸§ç‡: ä¸ç¨³å®š
- âŒ SDK lost frames: 816+

### ä¼˜åŒ–åç›®æ ‡
- âœ… å†…æ ¸ä¸¢åŒ…: 0 packets
- âœ… å¸§ç‡: ç¨³å®š 5 Hz
- âœ… SDK lost frames: < 10
- âœ… å›è°ƒå¤„ç†: < 25 ms
- âœ… Frame gap: æ¶ˆé™¤

## ğŸ”„ æ¢å¤é»˜è®¤è®¾ç½®

å¦‚æœéœ€è¦æ¢å¤ï¼š

```bash
# åˆ é™¤æŒä¹…åŒ–é…ç½®
sudo rm /etc/sysctl.d/99-gige-4k-camera.conf

# æ¢å¤é»˜è®¤å€¼
sudo sysctl -w net.core.rmem_max=212992
sudo sysctl -w net.core.rmem_default=212992

# é‡å¯ä»¥å®Œå…¨æ¢å¤
sudo reboot
```

## ğŸ“ æ•…éšœæ’é™¤

### Q: ä»ç„¶æœ‰å†…æ ¸ä¸¢åŒ…æ€ä¹ˆåŠï¼Ÿ
1. ç¡®è®¤ä¼˜åŒ–è„šæœ¬æˆåŠŸè¿è¡Œ
2. æ£€æŸ¥ `sysctl -a | grep rmem` ç¡®è®¤ç¼“å†²åŒºè®¾ç½®
3. å°è¯•é™ä½å¸§ç‡åˆ° 3 fps
4. è€ƒè™‘å‘å¸ƒ Bayer æ ¼å¼

### Q: ç›¸æœºæ— æ³•å¯åŠ¨
1. æ£€æŸ¥ç›¸æœºè¿æ¥: `ping 192.168.40.11`
2. æŸ¥çœ‹æ—¥å¿—: `cat ~/.ros/log/latest/galaxy_camera-*-stdout.log`
3. ç¡®è®¤ MTU: `ip link show eth0`

### Q: å¸§ç‡å¾ˆä½
1. æ£€æŸ¥å›è°ƒå¤„ç†æ—¶é—´ï¼ˆåº”è¯¥ < 30 msï¼‰
2. æ£€æŸ¥CPUå ç”¨
3. è€ƒè™‘é™ä½åˆ†è¾¨ç‡æˆ–ä½¿ç”¨ Bayer æ ¼å¼

### Q: unexpected_packets å¾ˆé«˜
è¿™å¯èƒ½æ˜¯ LiDAR æˆ–å…¶ä»–è®¾å¤‡çš„æµé‡ï¼š
1. ç¡®è®¤ LiDAR åœ¨ä¸åŒçš„ç½‘ç»œæ¥å£æˆ– VLAN
2. ä½¿ç”¨ `tcpdump -ni eth0 | grep 192.168.40` ç¡®è®¤æµé‡æ¥æº
3. è€ƒè™‘ä½¿ç”¨ç‹¬ç«‹ç½‘å¡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `ç½‘å¡å±‚ä¸¢åŒ…æ¶ˆé™¤æŒ‡å—.md` - ä¸€èˆ¬ä¼˜åŒ–æŒ‡å—
- `README_MONITORING.md` - ç›‘æ§ç³»ç»Ÿè¯´æ˜
- `/tmp/4k_camera_optimization.log` - ä¼˜åŒ–å‰åå¯¹æ¯”

## ğŸ‰ æ€»ç»“

**æ ¹æœ¬é—®é¢˜**: 4Kç›¸æœº (12 MB/å¸§) äº§ç”Ÿçš„æ•°æ®é‡è¶…å‡ºé»˜è®¤ç½‘ç»œç¼“å†²åŒºå®¹é‡

**è§£å†³æ–¹æ¡ˆ**: 
1. âœ… å¢å¤§å†…æ ¸ç¼“å†²åŒºåˆ° 256 MB
2. âœ… å¢å¤§ socket ç¼“å†²åŒºåˆ° 16 MB  
3. âœ… è°ƒæ•´è¶…æ—¶å‚æ•°
4. âœ… CPU æ€§èƒ½æ¨¡å¼
5. âœ… ç½‘ç»œä¼˜åŒ–

**éªŒè¯æ–¹æ³•**: 
- è¿è¡Œ `monitor_kernel_drops.sh` ç¡®è®¤ dropped = 0
- è¿è¡Œ tcpdump ç¡®è®¤ "0 packets dropped by kernel"

**å¦‚æœä»æœ‰é—®é¢˜**: é™ä½å¸§ç‡æˆ–ä½¿ç”¨ Bayer æ ¼å¼

---

*åˆ›å»ºæ—¶é—´: 2025-10-08*
*é’ˆå¯¹é—®é¢˜: 4096x3000 ç›¸æœºå†…æ ¸ä¸¢åŒ… 53%*
